<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>猫の給餌量（カロリー）計算｜体重とフードから1日の目安を自動計算</title>
  <meta name="description" content="体重・ライフステージ・状態を入力するだけ。猫の1日の必要カロリーとグラム数、1食あたりの量までわかる無料ツール。BCSからの理想体重推定にも対応。">
  <link rel="canonical" href="https://cat-tools.catnote.tokyo/calculate-cat-calorie">

  <!-- OGP（暫定のままでもOK。後で差し替え可） -->
  <meta property="og:title" content="猫の給餌量（カロリー）計算">
  <meta property="og:description" content="体重・状態・フードのカロリー密度を入れるだけ。1日の必要カロリーと与える量を自動計算。">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://cat-tools.catnote.tokyo/og-cat-calorie.png">
  <meta property="og:locale" content="ja_JP">
  <meta name="twitter:card" content="summary_large_image">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400..700&family=Outfit:wght@600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#FF69B4;
      --primary-strong:#E00070;
      --text:#111; --muted:#666; --border:#E9E9EA;

      --r-sm:8px; --r-md:12px; --r-lg:16px; --r-xl:24px;
      --s-1:8px; --s-2:16px; --s-3:24px; --s-4:40px;
      --ring:0 0 0 2px rgba(224,0,112,.35);
    }
    *,*::before,*::after{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:#fff; color:var(--text);
      font-family:"Zen Kaku Gothic New","Noto Sans JP",-apple-system,system-ui,Segoe UI,Meiryo,sans-serif;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    .container{ max-width:760px; margin:0 auto; padding:0 var(--s-3) var(--s-4) }

    .eyebrow{ font-size:14px; letter-spacing:.08em; text-transform:uppercase; color:rgba(224,0,112,.85); margin-top:var(--s-3) }
    h1{ font-size:32px; line-height:1.25; font-weight:700; margin:.4rem 0 0 }
    @media (min-width:768px){ h1{ font-size:40px; line-height:1.2 } }
    .lead{ font-size:14px; color:var(--muted); margin:.6rem 0 var(--s-3); line-height:1.7 }
    .section{ margin-top:var(--s-4) }
    .label{ font-size:18px; font-weight:700; color:#111 }

    /* 入力エリア（下線のみ） */
    .surface{
      padding:var(--s-3);
      border:none; border-radius:0;
      border-bottom:1px solid var(--border);
      overflow:hidden;
    }
    .row{ display:flex; flex-direction:column; gap:var(--s-2); margin-top:var(--s-2) }

    input[type="number"], input[type="text"], select{
      width:100%; height:56px; padding:0 var(--s-3);
      border:2px solid #F0C7D8; border-radius:var(--r-xl);
      font-size:16px; color:var(--text); background:#fff;
    }
    input:focus-visible, select:focus-visible{ outline:none; box-shadow:var(--ring) }

    .help{ font-size:13px; color:#808080; margin-top:4px }

    .grid-two{ display:grid; grid-template-columns:1fr 1fr; gap:var(--s-2) }
    @media (max-width:640px){ .grid-two{ grid-template-columns:1fr } }

    details.disclosure{
      margin-top:var(--s-2); border:1px dashed #f0c7d8; border-radius:12px; padding:10px 12px;
      background:#fff;
    }
    details.disclosure summary{ cursor:pointer; font-weight:600; }
    details.disclosure[open]{ background:#fff; }

    /* 結果表示 */
    .result{
      text-align:center; position:relative; padding-top:8px; padding-bottom:var(--s-3);
      border-bottom:1px solid var(--border);
    }
    .result .muted{ color:var(--muted); margin-bottom:6px; letter-spacing:.04em }
    .numeral{
      font-family:"Outfit",ui-sans-serif,system-ui,-apple-system,"Helvetica Neue",Arial,sans-serif;
      font-variant-numeric:tabular-nums; letter-spacing:-.01em;
    }
    .big{ display:flex; align-items:baseline; justify-content:center; gap:14px; font-size:0; flex-wrap:wrap }
    .age-group{ display:flex; align-items:baseline; gap:6px }
    .age-group .numeral{ font-size:56px; font-weight:800; color:var(--primary-strong) }
    .age-group .unit{ font-size:18px; color:#111; position:relative; top:-8px }
    @media (min-width:768px){
      .age-group .numeral{ font-size:72px }
      .age-group .unit{ top:-10px; font-size:20px }
    }

    .grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:0; margin-top:18px }
    .cell{ background:transparent; border-left:1px solid #F0C7D8; padding:14px 16px }
    .cell:first-child{ border-left:none }
    .cell .k{ font-size:12px; text-transform:uppercase; letter-spacing:.04em; color:#808080; text-align:center }
    .cell .v{ font-weight:700; font-size:16px; text-align:center; margin-top:6px; word-break:keep-all }

    .error{ color:#b00020; font-size:13px; margin-top:6px; min-height:1.2em }

    /* 共有ボタン＋メニュー */
    .share-btn{
      position:absolute; right:0; top:0; transform:translateY(-60%);
      width:40px; height:40px; border-radius:999px; border:1px solid #D7DADF;
      background:#fff; display:inline-grid; place-items:center; cursor:pointer;
    }
    .share-btn:hover{ border-color:#B7BBC3 }
    .share-menu{
      position:absolute; right:0; top:0; transform:translateY(-10%); z-index:20;
      background:#fff; border:1px solid #E5E7EB; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.08);
      padding:6px; display:none; min-width:220px;
    }
    .share-menu.open{ display:block }
    .share-item{
      display:flex; align-items:center; gap:10px; width:100%;
      padding:10px 12px; border-radius:8px; background:#fff; color:#111; text-decoration:none; cursor:pointer;
    }
    .share-item:hover{ background:#F8F9FB }
    .share-item svg{ flex-shrink:0 }

    .section-title{ margin-top:var(--s-4); padding-top:var(--s-2); border-top:1px solid var(--border); font-weight:800; font-size:22px; letter-spacing:-.01em }
    @media (min-width:768px){ .section-title{ font-size:24px } }
    details{ border:none; border-top:1px solid #eee; padding:18px 0 }
    details+details{ margin-top:0 }
    summary{ list-style:none; cursor:pointer; display:flex; align-items:center; justify-content:space-between; font-weight:400; color:#111 }
    summary::-webkit-details-marker{ display:none }
    summary:hover{ color:var(--primary-strong) }
    .chev{ transition:transform .15s ease }
    details[open] .chev{ transform:rotate(180deg) }

    .toast{
      position:fixed; left:50%; bottom:24px; transform:translateX(-50%);
      background:#111; color:#fff; font-size:14px; padding:10px 14px; border-radius:10px;
      opacity:0; pointer-events:none; transition:opacity .18s ease;
    }
    .toast.show{ opacity:1 }

    footer{ color:#888; font-size:13px; margin-top:var(--s-4) }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0 }
  </style>
</head>
<body>
  <main class="container">
    <!-- Hero -->
    <section class="section">
      <p class="eyebrow">猫の給餌量をかんたん計算</p>
      <h1>猫の給餌量（カロリー）計算</h1>
      <p class="lead">体重・状態・フードのカロリー密度を入れるだけで、1日の必要カロリーと与える量（g/日・1食あたり）が分かります。BCSから理想体重を使った計算にも対応。</p>

      <div class="surface">
        <div class="label">入力</div>
        <div class="row">
          <div class="grid-two">
            <div>
              <label class="sr-only" for="w">体重(kg)</label>
              <input id="w" type="number" step="0.1" min="0.1" placeholder="体重 (kg)">
              <div class="help">例: 4.2</div>
            </div>

            <div>
              <label class="sr-only" for="unit">フード単位</label>
              <select id="unit" aria-label="フード単位">
                <option value="kcal_per_100g">kcal / 100g（ドライ等）</option>
                <option value="kcal_per_cup">kcal / cup</option>
                <option value="kcal_per_can">kcal / 缶</option>
                <option value="kcal_per_pouch">kcal / パウチ</option>
              </select>
              <div class="help">製品ラベルの単位を選択</div>
            </div>

            <div>
              <label class="sr-only" for="energy">エネルギー量</label>
              <input id="energy" type="number" step="1" min="1" placeholder="エネルギー量">
              <div class="help" id="energyHelp">例: 380（kcal/100g）</div>
            </div>

            <div id="cupDensityWrap" hidden>
              <label class="sr-only" for="density">密度 (g/cup)</label>
              <input id="density" type="number" step="1" min="1" placeholder="密度 (g/cup)">
              <div class="help">任意：そのカップ1杯の重さ（g）</div>
            </div>

            <div>
              <label class="sr-only" for="meals">1日の回数</label>
              <input id="meals" type="number" step="1" min="1" value="2" placeholder="1日の回数">
              <div class="help">例: 2</div>
            </div>

            <div>
              <label class="sr-only" for="sex">去勢・避妊</label>
              <select id="sex" aria-label="去勢・避妊">
                <option value="neutered">去勢/避妊済み</option>
                <option value="intact">未去勢/未避妊</option>
              </select>
              <div class="help">成猫の係数選定に使用</div>
            </div>
          </div>

          <!-- 詳細設定（折りたたみ） -->
          <details class="disclosure">
            <summary>詳細設定（BCS/子猫・シニア/繁殖/活動/目標など）</summary>
            <div class="grid-two" style="margin-top:12px">
              <div>
                <label class="sr-only" for="bcs">BCS(1-9)</label>
                <input id="bcs" type="number" step="1" min="1" max="9" placeholder="BCS (1〜9) 任意">
                <div class="help">5が適正。1ポイント≒体脂肪10%の過不足目安</div>
              </div>
              <div>
                <label class="sr-only" for="ideal">理想体重で計算</label>
                <select id="ideal" aria-label="理想体重で計算">
                  <option value="true">理想体重を使う（推奨）</option>
                  <option value="false">現在体重を使う</option>
                </select>
                <div class="help">BCS未入力なら現在体重</div>
              </div>

              <div>
                <label class="sr-only" for="stage">ライフステージ</label>
                <select id="stage" aria-label="ライフステージ">
                  <option value="adult">成猫（〜約7歳）</option>
                  <option value="kitten_0_3m">子猫 0–3か月</option>
                  <option value="kitten_4_9m">子猫 4–9か月</option>
                  <option value="kitten_10m_to_sexual_maturity">子猫 10か月〜成熟前</option>
                  <option value="mature_senior">シニア 7–11歳</option>
                  <option value="super_senior">スーパーシニア 12歳〜</option>
                </select>
                <div class="help">子猫/シニア補正の目安に使用</div>
              </div>

              <div>
                <label class="sr-only" for="repro">繁殖</label>
                <select id="repro" aria-label="繁殖">
                  <option value="none">なし</option>
                  <option value="gestation">妊娠</option>
                  <option value="lactation">授乳</option>
                </select>
                <div class="help">授乳/妊娠は最優先で係数を決定</div>
              </div>

              <div>
                <label class="sr-only" for="activity">活動レベル</label>
                <select id="activity" aria-label="活動レベル">
                  <option value="normal">ふつう</option>
                  <option value="inactive">非活動的/肥満傾向</option>
                  <option value="active">活動的</option>
                </select>
              </div>

              <div>
                <label class="sr-only" for="goal">目標</label>
                <select id="goal" aria-label="目標">
                  <option value="maintain">維持</option>
                  <option value="loss">減量</option>
                  <option value="gain">増量/回復期</option>
                </select>
              </div>
            </div>
          </details>
        </div>

        <div id="error" class="error" role="alert" aria-live="polite"></div>
      </div>
    </section>

    <!-- Result -->
    <section id="resultSection" class="section" aria-live="polite">
      <div class="result">
        <div class="muted">1日の目安</div>

        <div class="big">
          <span class="age-group">
            <span id="kcal" class="numeral">--</span><span class="unit">kcal/日</span>
          </span>
          <span class="age-group">
            <span id="grams" class="numeral">--</span><span class="unit">g/日</span>
          </span>
        </div>

        <!-- 共有ボタン -->
        <button id="shareBtn" class="share-btn" aria-haspopup="menu" aria-expanded="false" aria-label="共有メニューを開く">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#69707D" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7"/>
            <path d="M12 16V4"/>
            <path d="M8 8l4-4 4 4"/>
          </svg>
        </button>
        <div id="shareMenu" class="share-menu" role="menu" aria-label="共有メニュー"></div>

        <div class="grid">
          <div class="cell"><div class="k">1食あたり</div><div id="perMeal" class="v">—</div></div>
          <div class="cell"><div class="k">個数/日（缶/パウチ/杯）</div><div id="unitsPerDay" class="v">—</div></div>
          <div class="cell"><div class="k">係数</div><div id="factor" class="v">—</div></div>
          <div class="cell"><div class="k">計算に使った体重</div><div id="usedWeight" class="v">—</div></div>
          <div class="cell" style="grid-column:1/-1"><div class="k">メモ</div><div id="note" class="v">—</div></div>
        </div>
      </div>
    </section>

    <!-- FAQ（常時表示） -->
    <section class="section" aria-labelledby="faqTitle">
      <h2 id="faqTitle" class="section-title">よくある質問</h2>
      <div>
        <details>
          <summary>この計算の考え方は？ <svg class="chev" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#444" stroke-width="1.5"><path d="M6 9l6 6 6-6"/></svg></summary>
          <div class="muted" style="margin-top:8px">
            RER（安静時必要量）=<code>70 × 体重^0.75</code> を使い、生活状態に合わせた係数を掛けて1日の必要カロリー（DER）を求めます。<br>
            計算値は<strong>スタート地点</strong>。個体差で±30〜50%ぶれることがあるため、1〜2週ごとに体重とBCSを見ながら微調整してください。
          </div>
        </details>
        <details>
          <summary>BCSから「理想体重」を使うのはなぜ？やり方は？ <svg class="chev" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#444" stroke-width="1.5"><path d="M6 9l6 6 6-6"/></svg></summary>
          <div class="muted" style="margin-top:8px">
            9段階BCSは1ポイント差≒体脂肪10%の過不足の目安です。<br>
            推定：<code>excess=0.10×(BCS−5)</code>。BCS&gt;5なら <code>理想体重=現在体重÷(1+excess)</code>、BCS&lt;5なら <code>現在体重÷(1−|excess|)</code>。<br>
            「理想体重で計算」をONにするとRERの体重としてこの値を使います（OFFなら現在体重）。
          </div>
        </details>
        <details>
          <summary>係数はどう選ばれますか？（優先順位） <svg class="chev" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#444" stroke-width="1.5"><path d="M6 9l6 6 6-6"/></svg></summary>
          <div class="muted" style="margin-top:8px">
            1) 授乳 &gt; 2) 妊娠 &gt; 3) 成長（子猫：3.0→2.5→2.0） &gt; 4) 減量/増量 &gt; 5) 成猫（去勢/未去勢/活動） &gt; 6) シニア補正 の順で<strong>ひとつだけ</strong>採用します。<br>
            例：授乳中なら他の設定より優先して ×4.0（目安）を使います。
          </div>
        </details>
        <details>
          <summary>フードの表示が「kcal/100g」以外なんだけど？ <svg class="chev" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#444" stroke-width="1.5"><path d="M6 9l6 6 6-6"/></svg></summary>
          <div class="muted" style="margin-top:8px">
            単位を切り替えられます。<br>
            ・<strong>kcal/100g</strong>：<code>g/日 = DER ÷ kcal/100g × 100</code><br>
            ・<strong>kcal/cup</strong>：<code>カップ/日 = DER ÷ kcal/cup</code>。重さ（g/cup）が分かれば g に換算します。<br>
            ・<strong>kcal/缶・パウチ</strong>：<code>個/日 = DER ÷ kcal/個</code>（端数は実運用に合わせて丸め）。
          </div>
        </details>
        <details>
          <summary>結果はどう使えばいい？微調整のコツは？ <svg class="chev" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#444" stroke-width="1.5"><path d="M6 9l6 6 6-6"/></svg></summary>
          <div class="muted" style="margin-top:8px">
            まずは計算どおりに始め、<strong>週1〜2回の体重/BCS記録</strong>を。増え続け/減り続ける場合は、与量を<strong>5〜10%</strong>ずつ上下して様子を見ましょう。<br>
            減量は<b>ゆっくり</b>が安全。授乳期は必要量が大きく変動するため、食べられる環境を用意しつつ体調をこまめに見てください。
          </div>
        </details>
      </div>
    </section>

    <footer class="section">© <span id="year"></span> CAT LINK tools</footer>
  </main>

  <!-- FAQ 構造化データ（簡易） -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"FAQPage",
    "mainEntity":[
      {"@type":"Question","name":"この計算の考え方は？","acceptedAnswer":{"@type":"Answer","text":"RER（安静時必要量）= 70 × 体重^0.75 を使い、生活状態に合わせた係数を掛けて1日の必要カロリー（DER）を求めます。計算値はスタート地点。個体差で±30〜50%ぶれることがあるため、1〜2週ごとに体重とBCSを見ながら微調整してください。"}},
      {"@type":"Question","name":"BCSから理想体重を使うのはなぜ？やり方は？","acceptedAnswer":{"@type":"Answer","text":"9段階BCSは1ポイント差≒体脂肪10%の過不足の目安です。excess=0.10×(BCS−5)。BCS>5なら 理想体重=現在体重÷(1+excess)、BCS<5なら 現在体重÷(1−|excess|)。『理想体重で計算』をONにするとRERの体重としてこの値を使います。"}},
      {"@type":"Question","name":"係数はどう選ばれますか？（優先順位）","acceptedAnswer":{"@type":"Answer","text":"1) 授乳 > 2) 妊娠 > 3) 成長（子猫：3.0→2.5→2.0）> 4) 減量/増量 > 5) 成猫（去勢/未去勢/活動）> 6) シニア補正 の順でひとつだけ採用します。"}},
      {"@type":"Question","name":"フードの表示が「kcal/100g」以外のときは？","acceptedAnswer":{"@type":"Answer","text":"kcal/cup は カップ/日=DER÷kcal/cup。密度(g/cup)が分かればg/日に換算。缶やパウチは 個/日=DER÷kcal/個（端数処理は実運用に合わせて）。"}},
      {"@type":"Question","name":"結果はどう使えばいい？微調整のコツは？","acceptedAnswer":{"@type":"Answer","text":"まずは計算どおりに始め、週1〜2回の体重/BCS記録を。増減が続く場合は与量を5〜10%ずつ上下して様子を見ましょう。減量はゆっくりが安全です。"}}
    ]
  }
  </script>

  <script>
    // ========= 共通ユーティリティ =========
    const $ = (s)=>document.querySelector(s);
    const yearEl = $('#year'); yearEl.textContent = String(new Date().getFullYear());
    const toast = document.createElement('div'); toast.className='toast'; document.body.appendChild(toast);
    function showToast(msg){ toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1600); }

    // ========= 入力参照 =========
    const w=$('#w'), unit=$('#unit'), energy=$('#energy'), energyHelp=$('#energyHelp'),
          densityWrap=$('#cupDensityWrap'), density=$('#density'),
          meals=$('#meals'), sex=$('#sex'),
          bcs=$('#bcs'), idealSel=$('#ideal'), stage=$('#stage'),
          repro=$('#repro'), activity=$('#activity'), goal=$('#goal');
    const errEl=$('#error');

    // ========= 出力参照 =========
    const kcalEl=$('#kcal'), gramsEl=$('#grams'), perMealEl=$('#perMeal'),
          unitsPerDayEl=$('#unitsPerDay'), factorEl=$('#factor'),
          usedWeightEl=$('#usedWeight'), noteEl=$('#note');

    // ========= 共有 =========
    const shareBtn=$('#shareBtn'), shareMenu=$('#shareMenu');
    shareBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleShare(); });
    document.addEventListener('click', (e)=> {
      if (!shareMenu.contains(e.target) && e.target !== shareBtn) toggleShare(false);
    });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') toggleShare(false); });

    function iconX(){ return `
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M18.2 3h2.4l-5.2 5.9L22 21h-4.8l-3.7-7-4.2 4.8V21H4V3h5.3v7.5L18.2 3z"/>
      </svg>`;}
    function iconShare(){ return `
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7"/><path d="M12 16V4"/><path d="M8 8l4-4 4 4"/>
      </svg>`;}
    function iconLink(){ return `
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" aria-hidden="true">
        <path d="M10 13a5 5 0 0 1 0-7l1.5-1.5a5 5 0 0 1 7 7L17 12"/>
        <path d="M14 11a5 5 0 0 1 0 7L12.5 19.5a5 5 0 1 1-7-7L7 12"/>
      </svg>`;}

    function buildShareMenu(){
      shareMenu.innerHTML = '';
      const url = new URL(location.href).toString();
      const text = (() => {
        const g = gramsEl.textContent;
        const p = perMealEl.textContent;
        if (g !== '—' && p !== '—') return `うちの猫の給餌量は「${g}/日（${p}）」でした🐾`;
        return `猫の給餌量（カロリー）を計算しました🐾`;
      })();

      if (navigator.share){
        const btnShare = document.createElement('button');
        btnShare.className='share-item';
        btnShare.innerHTML = iconShare() + '<span>この結果を共有</span>';
        btnShare.addEventListener('click', async () => {
          try { await navigator.share({ title: '猫の給餌量（カロリー）計算', text, url }); } catch(e){}
          toggleShare(false);
        });
        shareMenu.appendChild(btnShare);
      }

      const btnX = document.createElement('a');
      btnX.className='share-item';
      btnX.href = `https://x.com/intent/post?${new URLSearchParams({url, text}).toString()}`;
      btnX.target = '_blank'; btnX.rel='noopener';
      btnX.innerHTML = iconX() + '<span>Xでシェア</span>';
      btnX.addEventListener('click', ()=> toggleShare(false));
      shareMenu.appendChild(btnX);

      const btnCopy = document.createElement('button');
      btnCopy.className='share-item';
      btnCopy.innerHTML = iconLink() + '<span>リンクをコピー</span>';
      btnCopy.addEventListener('click', async () => {
        await navigator.clipboard.writeText(url);
        showToast('リンクをコピーしました');
        toggleShare(false);
      });
      shareMenu.appendChild(btnCopy);
    }
    function toggleShare(open){
      if (typeof open === 'undefined') open = !shareMenu.classList.contains('open');
      shareMenu.classList.toggle('open', open);
      shareBtn.setAttribute('aria-expanded', String(open));
      if (open) buildShareMenu();
    }

    // ========= 計算ロジック（仕様準拠） =========
    function idealWeightFromBCS(weight_kg, bcs_9pt){
      if (!(bcs_9pt >= 1 && bcs_9pt <= 9)) return weight_kg;
      const excess_ratio = 0.10 * (bcs_9pt - 5);
      if (excess_ratio > 0) return weight_kg / (1 + excess_ratio);
      if (excess_ratio < 0) return weight_kg / (1 - Math.abs(excess_ratio));
      return weight_kg;
    }
    function pickFactor(p){
      // 1) 繁殖
      if (p.reproduction === 'lactation') return { value: 4.0, label: '授乳 ×4.0（目安2.0〜6.0）', group:'reproduction' };
      if (p.reproduction === 'gestation') return { value: 2.5, label: '妊娠 ×2.5（目安2.0〜3.0）', group:'reproduction' };
      // 2) 成長（子猫）
      if (p.life_stage === 'kitten_0_3m') return { value: 3.0, label: '子猫 0–3か月 ×3.0', group:'growth' };
      if (p.life_stage === 'kitten_4_9m') return { value: 2.5, label: '子猫 4–9か月 ×2.5', group:'growth' };
      if (p.life_stage === 'kitten_10m_to_sexual_maturity') return { value: 2.0, label: '子猫 10か月〜成熟前 ×2.0', group:'growth' };
      // 3) 体重調整
      if (p.goal === 'loss') return { value: 0.85, label:'減量開始 ×0.85（0.8〜1.0）', group:'goal' };
      if (p.goal === 'gain') return { value: 1.3, label:'増量/回復期 ×1.3（1.2〜1.4）', group:'goal' };
      // 4) 成猫（去勢/活動）
      if (p.activity_level === 'inactive') return { value: 1.0, label:'非活動/肥満傾向 ×1.0', group:'adult' };
      if (p.sex_status === 'intact') return { value: 1.4, label:'成猫（未去勢/未避妊）×1.4', group:'adult' };
      if (p.activity_level === 'active') return { value: 1.6, label:'活動的 ×1.6', group:'adult' };
      // 5) シニア補正（既定：去勢/避妊済み 1.2 を基準に）
      let base=1.2, label='成猫（去勢/避妊済）×1.2';
      if (p.life_stage === 'mature_senior'){ base=1.2; label='シニア 7–11歳 ×1.2（1.1〜1.4）'; }
      if (p.life_stage === 'super_senior'){ base=1.1; label='スーパーシニア 12歳〜 ×1.1（個体差大）'; }
      return { value: base, label, group:'seniorOrAdult' };
    }

    function calcCatCalories(input) {
      const {
        weight_kg, bcs_9pt = null, use_ideal_weight = true,
        sex_status = 'neutered', life_stage = 'adult',
        activity_level = 'normal', goal = 'maintain',
        reproduction = 'none',
        food_energy_input_type = 'kcal_per_100g',
        food_energy_value, meals_per_day = 2,
        unit_density_g_per_cup = null
      } = input;

      const warnings = [];
      if (!(weight_kg > 0)) return { ok:false, error:'体重を入力してください' };
      if (weight_kg < 0.5 || weight_kg > 12) warnings.push('体重が一般的な家庭猫の範囲を外れています。目安として扱ってください。');
      if (!(food_energy_value > 0)) return { ok:false, error:'フードのカロリーを入力してください' };
      if (food_energy_input_type === 'kcal_per_100g' && (food_energy_value < 50 || food_energy_value > 500)) {
        warnings.push('kcal/100g が現実的な範囲を外れている可能性があります。');
      }
      if (!(meals_per_day >= 1 && meals_per_day <= 6)) return { ok:false, error:'1日の回数は1〜6回で入力してください' };

      // 1) 体重
      const ideal = (bcs_9pt == null) ? weight_kg : idealWeightFromBCS(weight_kg, bcs_9pt);
      const usedWeight = (String(use_ideal_weight) === 'true') ? ideal : weight_kg;
      if (usedWeight <= 0) return { ok:false, error:'体重の指定に問題があります' };

      // 2) RER
      const RER = 70 * Math.pow(usedWeight, 0.75);

      // 3) 係数
      const factorInfo = pickFactor({ reproduction, life_stage, goal, sex_status, activity_level });
      const factor = factorInfo.value;

      // 4) DER
      const DER = RER * factor;

      // 5) 与量算出
      let food_g_per_day = null;
      let units_per_day = null;
      if (food_energy_input_type === 'kcal_per_100g') {
        food_g_per_day = DER / food_energy_value * 100;
      } else if (food_energy_input_type === 'kcal_per_cup') {
        const cups = DER / food_energy_value;
        units_per_day = cups;
        if (unit_density_g_per_cup) food_g_per_day = cups * unit_density_g_per_cup;
      } else {
        // can/pouch
        units_per_day = DER / food_energy_value;
      }

      // 6-7) 丸め
      const round1 = (x)=> Math.round(x * 10) / 10;
      const daily_kcal = round1(DER);
      const grams_per_day = (food_g_per_day != null) ? round1(food_g_per_day) : null;
      const per_meal_g = (grams_per_day != null) ? round1(grams_per_day / meals_per_day) : null;
      const units = (units_per_day != null) ? round1(units_per_day) : null;

      let notes = 'これは一般的な目安です。1〜2週ごとに体重とBCSを記録し、必要に応じて±5〜10%で微調整してください。';
      if (goal === 'loss') notes = '減量は急がず、1〜2週ごとの体重チェックで±5〜10%ずつ微調整しましょう。';
      if (reproduction === 'lactation') notes = '授乳期は必要量が大きく変動します。食べたいだけ食べられる環境や高エネルギー食も検討を。';

      return {
        ok: true,
        daily_kcal,
        grams_per_day,
        per_meal_g,
        units_per_day: units,
        meals_per_day,
        used_weight_kg: Math.round(usedWeight * 100) / 100,
        factor_used: `${factor.toFixed(2)}（${factorInfo.label}）`,
        factor_source: factorInfo,
        warnings,
        notes
      };
    }

    // ========= 計算とUI更新 =========
    function update(){
      errEl.textContent = '';
      const input = {
        weight_kg: parseFloat(w.value),
        bcs_9pt: bcs.value ? parseInt(bcs.value,10) : null,
        use_ideal_weight: idealSel.value,
        sex_status: sex.value,
        life_stage: stage.value,
        activity_level: activity.value,
        goal: goal.value,
        reproduction: repro.value,
        food_energy_input_type: unit.value,
        food_energy_value: parseFloat(energy.value),
        meals_per_day: parseInt(meals.value || '2',10),
        unit_density_g_per_cup: density.value ? parseFloat(density.value) : null
      };
      const res = calcCatCalories(input);
      if (!res.ok){ errEl.textContent = res.error; return; }

      kcalEl.textContent = res.daily_kcal.toFixed(1);
      gramsEl.textContent = (res.grams_per_day != null) ? `${res.grams_per_day} g` : '—';
      perMealEl.textContent = (res.per_meal_g != null) ? `${res.per_meal_g} g/食` : '—';
      unitsPerDayEl.textContent = (res.units_per_day != null) ? `${res.units_per_day} /日` : '—';
      factorEl.textContent = res.factor_used;
      usedWeightEl.textContent = `${res.used_weight_kg} kg`;
      noteEl.textContent = res.notes;

      // URL同期（共有のため）
      const url = new URL(location.href);
      url.searchParams.set('w', w.value || '');
      url.searchParams.set('t', unit.value);
      url.searchParams.set('e', energy.value || '');
      url.searchParams.set('m', meals.value || '2');
      url.searchParams.set('x', sex.value);
      url.searchParams.set('b', bcs.value || '');
      url.searchParams.set('u', idealSel.value);
      url.searchParams.set('l', stage.value);
      url.searchParams.set('r', repro.value);
      url.searchParams.set('a', activity.value);
      url.searchParams.set('g', goal.value);
      if (density.value) url.searchParams.set('c', density.value);
      history.replaceState(null,'',url);
    }

    // 入力イベント
    [w,unit,energy,density,meals,sex,bcs,idealSel,stage,repro,activity,goal].forEach(el=>{
      el.addEventListener('input', update);
      el.addEventListener('change', update);
    });

    // 単位切替でプレースホルダ/補助欄を更新
    function refreshUnitUI(){
      const t = unit.value;
      if (t === 'kcal_per_100g'){
        energy.placeholder='エネルギー量 (kcal/100g)'; energyHelp.textContent='例: 380（kcal/100g）'; densityWrap.hidden=true;
      }else if (t === 'kcal_per_cup'){
        energy.placeholder='エネルギー量 (kcal/cup)'; energyHelp.textContent='例: 320（kcal/cup）'; densityWrap.hidden=false;
      }else if (t === 'kcal_per_can'){
        energy.placeholder='エネルギー量 (kcal/缶)'; energyHelp.textContent='例: 85（kcal/缶）'; densityWrap.hidden=true;
      }else{
        energy.placeholder='エネルギー量 (kcal/パウチ)'; energyHelp.textContent='例: 65（kcal/パウチ）'; densityWrap.hidden=true;
      }
    }
    unit.addEventListener('change', refreshUnitUI);

    // 復元
    (function restore(){
      const p = new URLSearchParams(location.search);
      if (p.get('w')) w.value = p.get('w');
      if (p.get('t')) unit.value = p.get('t');
      if (p.get('e')) energy.value = p.get('e');
      if (p.get('m')) meals.value = p.get('m');
      if (p.get('x')) sex.value = p.get('x');
      if (p.get('b')) bcs.value = p.get('b');
      if (p.get('u')) idealSel.value = p.get('u');
      if (p.get('l')) stage.value = p.get('l');
      if (p.get('r')) repro.value = p.get('r');
      if (p.get('a')) activity.value = p.get('a');
      if (p.get('g')) goal.value = p.get('g');
      if (p.get('c')) density.value = p.get('c');
      refreshUnitUI();
      update();
    })();

    // 初期：共有メニュー
    (function initShare(){
      const shareBtn = $('#shareBtn');
      if (!shareBtn) return;
      // 共有メニューは開いたときに都度再構築
    })();
  </script>
</body>
</html>
